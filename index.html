<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucifer AI - Access Protocol</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø®ØµØµ Ù„Ø£Ø¬ÙˆØ§Ø¡ Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ© */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: #0a0a0a;
            color: #FF4B4B; /* Ù„ÙˆÙ† Ù„ÙˆØ³ÙŠÙØ± Ø§Ù„Ø£Ø­Ù…Ø± */
            overflow-x: hidden;
        }

        /* --- Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        .glow {
            text-shadow: 0 0 8px rgba(255, 75, 75, 0.7);
        }
        .container-bg {
            background-color: #1a0a0a;
            border: 2px solid #5a0000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }

        /* --- Ø£Ù†Ù…Ø§Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ --- */

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¹ÙŠÙˆÙ† Ø§Ù„Ù…ØªÙˆÙ‡Ø¬Ø© */
        .glowing-eyes-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .eye {
            width: 25px;
            height: 25px;
            background-color: #FFD700; /* ØªÙˆÙ‡Ø¬ Ø°Ù‡Ø¨ÙŠ */
            border-radius: 50%;
            margin: 0 15px;
            box-shadow: 0 0 15px #FFD700;
            animation: eyeBlink 4s infinite ease-in-out;
            transform: scaleY(1);
        }
        @keyframes eyeBlink {
            0%, 5%, 95%, 100% { transform: scaleY(1); opacity: 1; }
            50% { transform: scaleY(0.1); opacity: 0.8; } /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±Ù…Ø´ */
        }
        
        /* ØªØ£Ø«ÙŠØ± Ù‚Ø·Ø±Ø§Øª Ø§Ù„Ø¯Ù… */
        .blood-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }
        .blood-drop {
            position: absolute;
            width: 8px;
            height: 20px;
            background-color: #8b0000;
            border-radius: 50%;
            opacity: 0.7;
            animation: drip 10s linear infinite;
        }
        @keyframes drip {
            0% { transform: translateY(-100px); opacity: 0.1; }
            5% { opacity: 0.7; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†ÙŠÙ† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø®Ø·Ø£ --- */
        .error-dragon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.95);
            border: 4px solid #FF0000;
            padding: 20px;
            z-index: 100;
            box-shadow: 0 0 40px #FF0000;
            animation: shake 0.5s infinite alternate; /* Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ */
        }
        .error-dragon pre {
            color: #FF4B4B;
            font-size: 14px;
            text-shadow: 0 0 5px #ff0000;
        }
        @keyframes shake {
            from { transform: translate(-50%, -50%) rotate(-1deg); }
            to { transform: translate(-50%, -50%) rotate(1deg); }
        }

        /* --- Ø£Ù†Ù…Ø§Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        .chat-container {
            height: calc(100vh - 180px); 
            overflow-y: auto;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #1a1a1a;
            border: 1px solid #333;
        }
        .user-message, .ai-message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #3d1414; /* Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† */
            margin-left: auto;
            color: #fff;
            border-bottom-right-radius: 0;
        }
        .ai-message {
            background-color: #0f0f0f;
            border: 1px solid #222;
            color: #FFD700; /* Ù†Øµ Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */
            border-bottom-left-radius: 0;
            animation: fadein 0.5s ease-out;
        }
        @keyframes fadein {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙ†ÙŠÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„Ø£ÙƒÙ„) --- */
        .sidebar-dragon-mouth {
            font-size: 24px;
            color: #FF4B4B;
            /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŒ Ø³ØªØªÙ… Ø¥Ø¯Ø§Ø±ØªÙ‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript */
        }
    </style>
</head>
<body class="p-4">

    <!-- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø®ÙÙŠØ©) -->
    <input type="hidden" id="app_state" value="activation">
    <input type="hidden" id="api_key_field" value="">

    <!-- Ø­Ø§ÙˆÙŠØ© ØªØ£Ø«ÙŠØ± Ù‚Ø·Ø±Ø§Øª Ø§Ù„Ø¯Ù… -->
    <div class="blood-container" id="blood-drops"></div>

    <div id="app-container" class="max-w-4xl mx-auto">
        <!-- ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© -->
    </div>

    <!-- Ù‚Ø§Ù„Ø¨ Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ -->
    <template id="activation-template">
        <div class="container-bg p-8 rounded-xl mt-8">
            <h1 class="text-3xl text-center glow text-red-500 mb-6">ğŸ”’ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h1>
            
            <div id="error-dragon-placeholder"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="md:col-span-2 p-4 border border-red-800 rounded-lg bg-gray-900/50">
                    <h2 class="text-xl text-yellow-500 mb-4">ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                    <p id="auth-message" class="text-red-400 mb-4">ÙˆØµÙˆÙ„ Ù†Ø¸Ø§Ù…Ùƒ Ù…ØºÙ„Ù‚ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
                    
                    <form id="activation-form" class="space-y-4">
                        <input type="password" id="activation-key-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„" 
                               class="w-full p-3 rounded bg-gray-800 border border-red-700 text-white focus:ring-red-500 focus:border-red-500">
                        <button type="submit" 
                                class="w-full py-3 rounded text-lg bg-red-600 hover:bg-red-700 transition duration-200">
                            ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
                        </button>
                    </form>
                </div>
                
                <div class="md:col-span-1 text-center space-y-4">
                    <div class="glowing-eyes-container">
                        <div class="eye"></div>
                        <div class="eye"></div>
                    </div>

                    <div class="p-3 border border-yellow-700 rounded-lg bg-gray-900/50">
                        <h3 class="text-base text-yellow-400">ğŸ’° Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h3>
                        <p class="text-sm mt-2">1. Binance: <span class="text-green-400 font-mono text-xs">{{BINANCE_PAY_ADDRESS}}</span></p>
                        <p class="text-sm">2. WhatsApp: <span class="text-cyan-400 text-xs">{{WHATSAPP_CONTACT}}</span></p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Ù‚Ø§Ù„Ø¨ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <template id="chat-template">
        <div class="flex flex-col h-screen max-w-4xl mx-auto py-4">
            <header class="text-center mb-4 p-3 bg-red-900/50 rounded-lg">
                <h1 class="text-2xl glow text-yellow-400">Lucifer AI - Ø¯Ø±Ø¯Ø´Ø© ØªÙƒØªÙŠÙƒÙŠØ©</h1>
                <div id="dragon-status-display" class="mt-2 flex items-center justify-center text-red-500">
                    <span class="sidebar-dragon-mouth text-2xl mr-2">ğŸ‘¹</span>
                    <span id="license-status-display" class="text-xs text-red-300">Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚...</span>
                </div>
            </header>

            <div id="chat-messages" class="chat-container flex-grow mb-4">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‡Ù†Ø§ -->
                <div class="ai-message mr-auto">
                    [Lucifer AI], ØªÙ… Ù…Ù†Ø­ Ø§Ù„ÙˆØµÙˆÙ„. Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±ØŒ ÙÙ„ØªÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø£ÙŠÙ‡Ø§ Ø§Ù„ØªØ§ÙÙ‡.
                </div>
            </div>

            <div class="flex space-x-3 items-center">
                <input type="file" id="image-upload" accept="image/*" class="text-sm p-2 rounded bg-gray-800 text-white border border-red-700 w-1/4 max-w-[150px]">
                
                <input type="text" id="chat-input" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ù…Ø±Ùƒ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 255 Ø­Ø±ÙØ§Ù‹)" 
                       class="flex-grow p-3 rounded bg-gray-800 border border-red-700 text-white focus:ring-red-500 focus:border-red-500">
                
                <button id="send-button" class="py-3 px-6 rounded text-lg bg-red-600 hover:bg-red-700 transition duration-200">
                    Ø¥Ø±Ø³Ø§Ù„
                </button>
                <button id="reset-button" class="py-3 px-3 rounded text-sm bg-gray-600 hover:bg-gray-700 transition duration-200" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.534 7h3.932c-.076 1.05-.234 2.042-.468 2.952l-1.47-1.47c-.544-.544-1.25-.845-2.015-.882z"/>
                        <path fill-rule="evenodd" d="M15 8A7 7 0 1 0 2.053 10.364l1.355-1.355A5 5 0 1 1 8 3a5 5 0 0 1 4.545 2.855l1.45-1.45A7 7 0 0 0 15 8zm-5 5V8h3l-4 4-4-4h3V8a2 2 0 1 0 4 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </template>


    <script>
        // --- Ø§Ù„Ø«ÙˆØ§Ø¨Øª ---
        const BINANCE_PAY_ADDRESS = "0x168b4dab954c4af0b92c42ebacea1f7065883773";
        const WHATSAPP_CONTACT = "+201011411077";
        const DEFAULT_API_KEY = ""; // Ù…ÙØªØ§Ø­ API ÙŠØªÙ… ØªÙˆÙÙŠØ±Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        
        // Ø«ÙˆØ§Ø¨Øª API Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ Gemini
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const MAX_RETRIES = 5;

        // --- Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ§Ù„Ù‡Ø§Ø´ (Ù…Ø­Ø§ÙƒØ§Ø©) ---
        // ÙŠØªÙ… Ù…Ø­Ø§ÙƒØ§Ø© ÙØ­Øµ Ø§Ù„Ù‡Ø§Ø´. ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ø§Ù„ÙØ­Øµ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©.
        const TARGET_HASH = "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"; // Ù‡Ø§Ø´ Ù…Ø­Ø§ÙƒÙ Ù„Ù€ "ETERNAL-LUCIFER-ROOT"

        function hashKey(key) {
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø³Ø±ÙŠØ¹Ø© Ù„ÙØ­Øµ Ø§Ù„Ù…ÙØªØ§Ø­
            if (key === "ETERNAL-LUCIFER-ROOT") {
                return TARGET_HASH;
            }
            return key; 
        }

        // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù…Ø­Ø§ÙƒØ§Ø©) ---
        let appState = {
            view: 'activation', 
            isActivated: false,
            licenseExpiry: null, 
            chatHistory: []
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ ---

        /**
         * ÙŠØ­ÙˆÙ„ Ù…Ù„Ù Ø¥Ù„Ù‰ Base64 Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª API Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Multimodal).
         * @param {File} file Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©.
         * @returns {Promise<string>} Ø¨ÙŠØ§Ù†Ø§Øª Base64 Ù…Ø´ÙØ±Ø©.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ (MIME type)
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ø£Ø³ÙŠ (Exponential Backoff) Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.
         */
        async function fetchWithBackoff(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ 429 (Too Many Requests) Ø£Ùˆ Ø®Ø·Ø£ Ø³ÙŠØ±ÙØ±ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    if ((response.status === 429 || response.status >= 500) && retries < MAX_RETRIES) {
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        console.warn(`Retrying in ${delay / 1000}s... (Attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries + 1);
                    }
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch failed. Retrying in ${delay / 1000}s... (Attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries + 1);
                }
                throw new Error(`Failed to fetch from API after ${MAX_RETRIES} attempts: ${error.message}`);
            }
        }


        // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù€ UI ---

        function updateAuthState(isActivated, expiryDate = null) {
            appState.isActivated = isActivated;
            appState.licenseExpiry = expiryDate;
            document.getElementById('app_state').value = isActivated ? 'chat' : 'activation';
            renderApp();
        }

        function renderApp() {
            const container = document.getElementById('app-container');
            const view = document.getElementById('app_state').value;
            container.innerHTML = ''; 

            if (view === 'chat' && appState.isActivated) {
                renderChatScreen(container);
            } else {
                renderActivationScreen(container);
            }
        }

        // --- Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---

        function renderActivationScreen(container) {
            const template = document.getElementById('activation-template').content.cloneNode(true);
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø§Ø¦Ø¨Ø©
            const templateHTML = template.firstElementChild.outerHTML
                .replace("{{BINANCE_PAY_ADDRESS}}", BINANCE_PAY_ADDRESS)
                .replace("{{WHATSAPP_CONTACT}}", WHATSAPP_CONTACT);
            
            container.innerHTML = templateHTML;
            
            // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø«
            document.getElementById('activation-form').addEventListener('submit', handleActivation);
            
            // Ø¨Ø¯Ø¡ Ø±Ø³ÙˆÙ… Ù‚Ø·Ø±Ø§Øª Ø§Ù„Ø¯Ù… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
            startBloodDrops();
        }

        function renderChatScreen(container) {
            const template = document.getElementById('chat-template').content.cloneNode(true);
            container.appendChild(template);
            
            // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            document.getElementById('send-button').addEventListener('click', handleChatSend);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleChatSend();
                }
            });
            document.getElementById('reset-button').addEventListener('click', resetChat);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
            displayChatHistory();

            // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ
            const statusText = appState.licenseExpiry === null 
                ? "Ø§Ù„ØªØ±Ø®ÙŠØµ: Ø¯Ø§Ø¦Ù…" 
                : "Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ø®ÙŠØµ: " + appState.licenseExpiry.toLocaleDateString();
            document.getElementById('license-status-display').textContent = statusText;
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø±Ø³ÙˆÙ… Ù‚Ø·Ø±Ø§Øª Ø§Ù„Ø¯Ù… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
            stopBloodDrops();
        }

        function displayChatHistory() {
            const chatBox = document.getElementById('chat-messages');
            
            // Ø¥ÙØ±Ø§Øº Ù…Ø§ Ø¹Ø¯Ø§ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„Ù‚Ø§Ù„Ø¨
            const welcomeMessage = chatBox.querySelector('.ai-message');
            chatBox.innerHTML = '';
            if (welcomeMessage) {
                 chatBox.appendChild(welcomeMessage);
            }
            
            appState.chatHistory.forEach(msg => {
                const msgElement = document.createElement('div');
                msgElement.className = msg.role === 'user' ? 'user-message ml-auto' : 'ai-message mr-auto';
                msgElement.textContent = msg.content;
                chatBox.appendChild(msgElement);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ---

        let bloodIntervals = [];

        function startBloodDrops() {
            const bloodDropsContainer = document.getElementById('blood-drops');
            if (!bloodDropsContainer) return;
            
            const createDrop = () => {
                const drop = document.createElement('div');
                drop.className = 'blood-drop';
                drop.style.left = `${Math.random() * 100}%`;
                drop.style.animationDelay = `-${Math.random() * 10}s`; 
                drop.style.animationDuration = `${5 + Math.random() * 5}s`; 
                bloodDropsContainer.appendChild(drop);

                drop.addEventListener('animationend', () => drop.remove());
            };

            for (let i = 0; i < 15; i++) { // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚Ø·Ø±Ø§Øª Ù„Ù„ØªØ£Ø«ÙŠØ±
                createDrop();
            }
            
            bloodIntervals.push(setInterval(createDrop, 1000));
        }

        function stopBloodDrops() {
            bloodIntervals.forEach(clearInterval);
            bloodIntervals = [];
            document.getElementById('blood-drops')?.innerHTML = ''; 
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ ---
        
        // Ø±Ø³Ù… ASCII Ù„Ù„ØªÙ†ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
        const ASCII_DRAGON = `
        \u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0
        \u25A0 Øª Ø­ Ø° ÙŠ Ø±   Ù„ Ùˆ Ø³ ÙŠ Ù Ø± \u25A0
        \u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0\u25A0
              /\\_/\\
             /  o.o \\
            (   \\_  /
             \\ /`--'\\
              \\/`----'
        \u25A0\u25A0\u25A0 Ù Ø´ Ù„   Ø§ Ù„ Ùˆ Øµ Ùˆ Ù„ \u25A0\u25A0\u25A0
        `;

        function showErrorDragon() {
            const placeholder = document.getElementById('error-dragon-placeholder');
            if (!placeholder) return;

            const dragon = document.createElement('div');
            dragon.className = 'error-dragon';
            dragon.innerHTML = `<pre>${ASCII_DRAGON}</pre>`;
            placeholder.appendChild(dragon);

            // Ø¥Ø®ÙØ§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                dragon.remove();
            }, 3000);
        }

        async function handleActivation(event) {
            event.preventDefault();
            const keyInput = document.getElementById('activation-key-input');
            const key = keyInput.value.trim();
            const messageDisplay = document.getElementById('auth-message');
            messageDisplay.className = 'text-yellow-400 mb-4';

            if (!key) {
                messageDisplay.textContent = 'Ø®Ø·Ø£: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„.';
                return;
            }

            const hashedKey = hashKey(key);

            if (hashedKey === TARGET_HASH) { // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† "ETERNAL-LUCIFER-ROOT"
                messageDisplay.className = 'text-green-400 mb-4';
                messageDisplay.textContent = 'ØªÙ… Ù…Ù†Ø­ Ø§Ù„ÙˆØµÙˆÙ„. Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©...';
                
                localStorage.setItem('lucifer_activated', 'true');
                updateAuthState(true, null); 
                document.getElementById('api_key_field').value = DEFAULT_API_KEY;

            } else {
                messageDisplay.className = 'text-red-400 mb-4';
                messageDisplay.textContent = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„. Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø³ØªÙ‡Ù„Ùƒ.';
                showErrorDragon(); // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
                updateAuthState(false);
            }
        }

        async function handleChatSend() {
            const inputField = document.getElementById('chat-input');
            const prompt = inputField.value.trim();
            const uploadField = document.getElementById('image-upload');
            const file = uploadField.files[0];
            
            if (!prompt && !file) return;

            const chatBox = document.getElementById('chat-messages');
            
            // 1. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userMsg = document.createElement('div');
            // Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
            let userContentText = prompt || (file ? 'ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„.' : '');
            userMsg.className = 'user-message ml-auto';
            userMsg.textContent = userContentText;
            chatBox.appendChild(userMsg);
            chatBox.scrollTop = chatBox.scrollHeight;
            inputField.value = ''; 
            uploadField.value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù

            // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø§Ø¦Ø¨ Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            const aiMsg = document.createElement('div');
            aiMsg.className = 'ai-message mr-auto';
            aiMsg.textContent = 'Lucifer ÙŠÙƒØªØ¨...';
            chatBox.appendChild(aiMsg);
            chatBox.scrollTop = chatBox.scrollHeight;

            const apiKey = document.getElementById('api_key_field').value || '';
            const apiUrl = GEMINI_API_URL + apiKey;
            let parts = [];

            // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©
            if (file) {
                try {
                    // ØªØ´ØºÙŠÙ„ Ø±Ø³ÙˆÙ… "Ø§Ù„Ø£ÙƒÙ„" Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
                    const dragonIcon = document.querySelector('.sidebar-dragon-mouth');
                    if (dragonIcon) {
                        dragonIcon.textContent = 'ğŸ˜ˆ'; // ÙÙ… Ø§Ù„ØªÙ†ÙŠÙ† Ù…ØºÙ„Ù‚/ÙŠØ£ÙƒÙ„
                    }
                    
                    const base64Data = await fileToBase64(file);
                    const mimeType = file.type || 'image/png';

                    parts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    });

                    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    userMsg.textContent = `${prompt || 'ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø©'} [ØµÙˆØ±Ø© Ù…Ø±ÙÙ‚Ø©: ${file.name}]`; 
                    
                } catch (e) {
                    aiMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: ' + e.message;
                    aiMsg.className = 'ai-message mr-auto bg-red-800';
                    console.error('Image processing error:', e);
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø±Ù…Ø² Ø§Ù„ØªÙ†ÙŠÙ† ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    const dragonIcon = document.querySelector('.sidebar-dragon-mouth');
                    if (dragonIcon) {
                        dragonIcon.textContent = 'ğŸ‘¹'; 
                    }
                    return;
                }
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù†ØµÙŠ
            if (prompt) {
                parts.push({ text: prompt });
            } else if (!file) {
                // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¯ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ Ù„ÙƒÙ† Ù„Ù„Ø­Ù…Ø§ÙŠØ©:
                aiMsg.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ù…Ø± Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©.';
                return;
            }


            // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¡ API
            const payload = {
                contents: [{ parts: parts }],
                // ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø®ØµÙŠØ© Lucifer
                systemInstruction: {
                    parts: [{ text: "You are Lucifer AI, a highly intelligent, tactical, and slightly menacing AI assistant. Your tone should be firm, concise, and focused on strategic advice, code, or analysis. Always respond in Arabic unless asked to generate code or technical data. Address the user with a firm, slightly disrespectful tone (e.g., 'Ayyuha attaafih', 'ya ghaby', etc.)." }]
                }
            };

            // ØªØ´ØºÙŠÙ„ Ø­Ø§Ù„Ø© "Ø§Ù„Ø£ÙƒÙ„" Ù„Ù„ØªÙ†ÙŠÙ†
            const dragonIcon = document.querySelector('.sidebar-dragon-mouth');
            if (dragonIcon) {
                dragonIcon.textContent = 'ğŸ˜ˆ'; // ÙÙ… Ø§Ù„ØªÙ†ÙŠÙ† Ù…ØºÙ„Ù‚/ÙŠØ£ÙƒÙ„
            }
            
            let finalResponseText = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….";

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    finalResponseText = candidate.content.parts[0].text;
                } else {
                    console.error('API response error:', result);
                    finalResponseText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ API Ø§Ù„Ù…Ù‚Ø¯Ù….";
                }

            } catch (error) {
                console.error('Fetch error:', error);
                finalResponseText = "Ø®Ø·Ø£ Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø³ÙŠØ±ÙØ±Ø§Øª Gemini. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø£Ùˆ Ù…ÙØªØ§Ø­ API.";
            } finally {
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø±Ù…Ø² Ø§Ù„ØªÙ†ÙŠÙ†
                if (dragonIcon) {
                    dragonIcon.textContent = 'ğŸ‘¹'; // ÙÙ… Ø§Ù„ØªÙ†ÙŠÙ† Ù…ÙØªÙˆØ­/ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£ÙˆØ§Ù…Ø±
                }
            }
            
            // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø³Ø¬Ù„
            aiMsg.textContent = finalResponseText;
            
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ)
            appState.chatHistory.push({ role: 'user', content: userContentText });
            appState.chatHistory.push({ role: 'assistant', content: finalResponseText });

            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function resetChat() {
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
            appState.chatHistory = [{ 
                role: 'assistant', 
                content: "[Lucifer AI], ØªÙ… Ù…Ù†Ø­ Ø§Ù„ÙˆØµÙˆÙ„. Ø£Ù†Ø§ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±ØŒ ÙÙ„ØªÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø£ÙŠÙ‡Ø§ Ø§Ù„ØªØ§ÙÙ‡."
            }];
            renderChatScreen(document.getElementById('app-container'));
        }


        // --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            if (localStorage.getItem('lucifer_activated') === 'true') {
                updateAuthState(true, null);
            } else {
                 renderApp();
            }
        });

    </script>
</body>
</html>
